<html>
<head>
<link rel="stylesheet" href="popup.css">
<script language="javascript">

var users_links = function(logins, upic_size){
    var l = null;
    var s = '';
    upic_size = upic_size || 'middle';
    for (var i in logins) { 
        l = logins[i];
        s += '<div class="yauser">';
        if (upic_size != null){
            s += '<div class="u-' + upic_size + '"><img src="http://upics.yandex.net/get/' + l + '/' + upic_size + '" alt="a"></div>';
        }
        s += '<div class="name">';
            s += '<a href="http://' + l + '.ya.ru/" target="_blank">' + l + '</a>';
        s += '</div>';
        s += '</div>';
    }
    return s;
}


var build_users = function(id, users, title){
    document.getElementById(id).innerHTML = users_links(users);
    document.getElementById(id + "_title").innerHTML = title;
    var this_id = id;
    document.getElementById(id + "_title").addEventListener('click', function(e){
        toggle(this_id);
        return true;
    }, true);
}

chrome.tabs.getSelected(null, function(tab){
    var current_url = tab.url;
    if (current_url.indexOf('chrome-extension://') == 0){
        console.debug('rewrite to swan');
        current_url = 'http://swan.ya.ru'
    }
    chrome.extension.sendRequest({ask: "get_friends", url: current_url}, function(response){
        var current_user = response.current_user;
        build_users("current_user", current_user, "Ваши друзья [" +  current_user.length + "]");
        if (!response.at_home) {
            var this_user = response.this_user;
            var intersection = current_user.filter(function(n) {
                if(this_user.indexOf(n) == -1)
                    return false;
                return true;
            });
            build_users("intersection", intersection, "Пересечение [" +  intersection.length + "]");

            var minus = this_user.filter(function(n) {
                if(current_user.indexOf(n) == -1){
                    return true;
                }
                return false;
            });
            build_users("minus", minus, 'Есть у ' + response.this_user_login + ', но нет у вас [' + minus.length + ']');
            toggle("guest");
            toggle("current_user")
        }
    });
});


function toggle(elem_id){
    var elem = document.getElementById(elem_id);
    if (elem.style.display){
        elem.style.display = "";
        elem.style.visibility ="hidden";
        elem.style.visibility ="visible";
    } else {
        elem.style.display = "none";
    }
    return true;
}

</script>
</head>
<body>
  <div id="guest" style="display: none;">
      <div class="container">
          <span id="intersection_title" class="pseudo-link">Пересечение</span>
          <div id="intersection" class="users"></div>
      </div>

      <div class="container">
          <span id="minus_title" class="pseudo-link">Его(Её) друзья которых нет у вас</span>
          <div id="minus" style="display:none;">
          </div>
      </div>

  </div>

  <div class="container">
      <span id="current_user_title" class="pseudo-link">Все ваши друзья</span>
      <div id="current_user">
      </div>
  </div>
</body>
<!-- vim: set filetype=javascript : -->
</html>
